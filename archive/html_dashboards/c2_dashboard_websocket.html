<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Command & Control - Real-Time Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
        }
        
        /* Matrix rain background */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }
        
        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(0,255,0,0.2) 0%, rgba(0,0,0,0) 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #0f0;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        
        h1 {
            font-size: 3em;
            text-shadow: 0 0 20px #0f0, 0 0 40px #0f0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Connection status */
        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border: 1px solid #0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f00;
        }
        
        .status-dot.connected {
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(0,255,0,0.1);
            border: 1px solid #0f0;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,255,0,0.3);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* Bots grid */
        .bots-container {
            margin: 30px 0;
        }
        
        .bot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .bot-card {
            background: rgba(0,255,0,0.05);
            border: 1px solid #0f0;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .bot-card:hover {
            background: rgba(0,255,0,0.1);
            transform: scale(1.02);
        }
        
        .bot-card.selected {
            border-color: #ff0;
            box-shadow: 0 0 20px rgba(255,255,0,0.5);
        }
        
        .bot-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        
        .bot-status.offline {
            background: #f00;
            box-shadow: 0 0 10px #f00;
        }
        
        /* Command panel */
        .command-panel {
            background: rgba(0,255,0,0.05);
            border: 1px solid #0f0;
            padding: 20px;
            margin: 30px 0;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background: transparent;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            text-transform: uppercase;
        }
        
        button:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 20px #0f0;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Activity log */
        .activity-log {
            background: #000;
            border: 1px solid #0f0;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
            margin-top: 30px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .log-entry:hover {
            background: rgba(0,255,0,0.1);
        }
        
        .log-entry.attack {
            border-left-color: #f00;
        }
        
        .log-entry.c2 {
            border-left-color: #0f0;
        }
        
        .log-entry.lateral {
            border-left-color: #ff0;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }
        
        .modal-content {
            background: #111;
            border: 2px solid #0f0;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            float: right;
            font-size: 30px;
            cursor: pointer;
            color: #0f0;
        }
        
        .close-modal:hover {
            color: #ff0;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #0f0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            border-color: #0f0;
        }
        
        .tab.active {
            border-color: #0f0;
            background: rgba(0,255,0,0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Screenshots gallery */
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .screenshot-thumb {
            border: 1px solid #0f0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            padding-bottom: 75%;
            background: #000;
        }
        
        .screenshot-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        
        .screenshot-thumb img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Keylog viewer */
        .keylog-viewer {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0,255,0,0.1);
            border-top: 3px solid #0f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,255,0,0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 5px;
            animation: slideIn 0.3s;
            z-index: 2000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <canvas class="matrix-bg" id="matrix"></canvas>
    
    <div class="header">
        <h1>C2 COMMAND & CONTROL</h1>
        <p>ESCAPE ROOM DEMO - REAL-TIME DASHBOARD</p>
        <div class="connection-status">
            <div class="status-dot" id="ws-status"></div>
            <span id="ws-status-text">Connecting...</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <h3>Total Bots</h3>
                <div class="stat-value" id="total-bots">0</div>
            </div>
            <div class="stat-card">
                <h3>Active</h3>
                <div class="stat-value" id="active-bots">0</div>
            </div>
            <div class="stat-card">
                <h3>Commands Sent</h3>
                <div class="stat-value" id="total-commands">0</div>
            </div>
            <div class="stat-card">
                <h3>Data Collected</h3>
                <div class="stat-value" id="data-collected">0 MB</div>
            </div>
        </div>
        
        <!-- Command Panel -->
        <div class="command-panel">
            <h2>COMMAND CENTER</h2>
            <p>Selected Bots: <span id="selected-count">0</span></p>
            <div class="command-buttons">
                <button onclick="sendCommand('SYSINFO')">System Info</button>
                <button onclick="sendCommand('SCREENSHOT')">Screenshot</button>
                <button onclick="sendCommand('KEYLOG:START')">Start Keylogger</button>
                <button onclick="sendCommand('KEYLOG:DUMP')">Dump Keylogs</button>
                <button onclick="sendCommand('PROC')">Process List</button>
                <button onclick="sendCommand('NETSTAT')">Network Connections</button>
                <button onclick="sendCommand('PERSISTENCE')">Install Persistence</button>
                <button onclick="sendCommand('ELEVATE')">Elevate Privileges</button>
                <button onclick="sendCommand('BROWSER_CREDS')">Steal Browser Creds</button>
                <button onclick="sendCommand('WEBCAM:CAPTURE')">Capture Webcam</button>
                <button onclick="sendCommand('MIC:RECORD:START')">Record Audio</button>
                <button onclick="sendCommand('CLEARLOG')">Clear Logs</button>
            </div>
        </div>
        
        <!-- Bots -->
        <div class="bots-container">
            <h2>CONNECTED BOTS</h2>
            <div class="bot-grid" id="bot-grid"></div>
        </div>
        
        <!-- Activity Log -->
        <div class="activity-log" id="activity-log">
            <h3>ACTIVITY LOG</h3>
        </div>
    </div>
    
    <!-- Bot Detail Modal -->
    <div class="modal" id="bot-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modal-bot-name">Bot Details</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('info')">System Info</div>
                <div class="tab" onclick="showTab('screenshots')">Screenshots</div>
                <div class="tab" onclick="showTab('keylogs')">Keylogs</div>
                <div class="tab" onclick="showTab('commands')">Commands</div>
            </div>
            
            <div class="tab-content active" id="tab-info">
                <div id="bot-info"></div>
            </div>
            
            <div class="tab-content" id="tab-screenshots">
                <div class="screenshot-grid" id="screenshot-grid"></div>
            </div>
            
            <div class="tab-content" id="tab-keylogs">
                <div class="keylog-viewer" id="keylog-viewer"></div>
            </div>
            
            <div class="tab-content" id="tab-commands">
                <div id="command-history"></div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket connection
        let ws = null;
        let wsConnected = false;
        let selectedBots = new Set();
        let botsData = new Map();
        let reconnectTimeout = null;
        
        // Initialize WebSocket connection
        function connectWebSocket() {
            console.log('Connecting to WebSocket...');
            
            // First get WebSocket URL from server
            fetch('/ws-info')
                .then(res => res.json())
                .then(info => {
                    ws = new WebSocket(info.ws_url || 'ws://localhost:8081');
                    
                    ws.onopen = () => {
                        console.log('WebSocket connected');
                        wsConnected = true;
                        updateConnectionStatus(true);
                        
                        // Clear reconnect timeout
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                            reconnectTimeout = null;
                        }
                        
                        // Request initial data
                        ws.send(JSON.stringify({ type: 'get_status' }));
                        ws.send(JSON.stringify({ type: 'get_clients' }));
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    };
                    
                    ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        wsConnected = false;
                        updateConnectionStatus(false);
                        
                        // Attempt to reconnect after 3 seconds
                        reconnectTimeout = setTimeout(connectWebSocket, 3000);
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                })
                .catch(() => {
                    // Fallback to default WebSocket URL
                    ws = new WebSocket('ws://localhost:8081');
                    // Set up handlers as above...
                });
        }
        
        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'welcome':
                    console.log('Welcome message:', data.message);
                    break;
                
                case 'status_update':
                    updateStats(data.data);
                    break;
                
                case 'clients_update':
                    updateBots(data.data.clients);
                    break;
                
                case 'activity_log':
                    updateActivityLog(data.data.activities);
                    break;
                
                case 'new_screenshot':
                    showNotification(`New screenshot from ${data.data.client_id}`);
                    // Update UI if viewing this client
                    if (document.getElementById('bot-modal').style.display === 'block') {
                        ws.send(JSON.stringify({
                            type: 'get_client_detail',
                            client_id: data.data.client_id
                        }));
                    }
                    break;
                
                case 'new_keylog':
                    showNotification(`New keylog data from ${data.data.client_id}`);
                    break;
                
                case 'command_result':
                    handleCommandResult(data.result);
                    break;
                
                case 'client_detail':
                    updateClientDetail(data.data);
                    break;
            }
        }
        
        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('ws-status');
            const statusText = document.getElementById('ws-status-text');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
            }
        }
        
        // Update stats
        function updateStats(stats) {
            document.getElementById('total-bots').textContent = stats.total_bots || 0;
            document.getElementById('active-bots').textContent = stats.active_bots || 0;
            document.getElementById('total-commands').textContent = stats.total_commands || 0;
        }
        
        // Update bots grid
        function updateBots(clients) {
            const grid = document.getElementById('bot-grid');
            
            clients.forEach(bot => {
                botsData.set(bot.id, bot);
                
                let card = document.getElementById(`bot-${bot.id}`);
                if (!card) {
                    // Create new bot card
                    card = document.createElement('div');
                    card.className = 'bot-card';
                    card.id = `bot-${bot.id}`;
                    card.onclick = () => toggleBotSelection(bot.id);
                    card.ondblclick = () => showBotDetails(bot.id);
                    grid.appendChild(card);
                }
                
                // Update card content
                card.innerHTML = `
                    <div class="bot-status ${bot.status === 'active' ? '' : 'offline'}"></div>
                    <h3>${bot.hostname || bot.id}</h3>
                    <p><strong>IP:</strong> ${bot.ip}</p>
                    <p><strong>User:</strong> ${bot.username}</p>
                    <p><strong>OS:</strong> ${bot.os}</p>
                    <p><strong>Elevated:</strong> ${bot.elevated ? 'Yes' : 'No'}</p>
                    <p><strong>Beacons:</strong> ${bot.beacon_count || 0}</p>
                    <p><strong>Last Seen:</strong> ${new Date(bot.last_seen * 1000).toLocaleTimeString()}</p>
                `;
                
                if (selectedBots.has(bot.id)) {
                    card.classList.add('selected');
                }
            });
            
            // Remove offline bots not in update
            const activeIds = new Set(clients.map(c => c.id));
            botsData.forEach((bot, id) => {
                if (!activeIds.has(id)) {
                    const card = document.getElementById(`bot-${id}`);
                    if (card) {
                        card.querySelector('.bot-status').classList.add('offline');
                    }
                }
            });
        }
        
        // Toggle bot selection
        function toggleBotSelection(botId) {
            if (selectedBots.has(botId)) {
                selectedBots.delete(botId);
                document.getElementById(`bot-${botId}`).classList.remove('selected');
            } else {
                selectedBots.add(botId);
                document.getElementById(`bot-${botId}`).classList.add('selected');
            }
            
            document.getElementById('selected-count').textContent = selectedBots.size;
        }
        
        // Show bot details
        function showBotDetails(botId) {
            const bot = botsData.get(botId);
            if (!bot) return;
            
            document.getElementById('modal-bot-name').textContent = `${bot.hostname} (${bot.id})`;
            document.getElementById('bot-modal').style.display = 'block';
            
            // Request detailed info
            if (ws && wsConnected) {
                ws.send(JSON.stringify({
                    type: 'get_client_detail',
                    client_id: botId
                }));
            }
            
            // Show info tab by default
            showTab('info');
            
            // Update bot info
            const infoDiv = document.getElementById('bot-info');
            infoDiv.innerHTML = `
                <p><strong>Client ID:</strong> ${bot.id}</p>
                <p><strong>IP Address:</strong> ${bot.ip}</p>
                <p><strong>Hostname:</strong> ${bot.hostname}</p>
                <p><strong>Username:</strong> ${bot.username}</p>
                <p><strong>Operating System:</strong> ${bot.os}</p>
                <p><strong>Privileges:</strong> ${bot.elevated ? 'Administrator' : 'User'}</p>
                <p><strong>Status:</strong> ${bot.status}</p>
                <p><strong>Connected Since:</strong> ${new Date(bot.connect_time * 1000).toLocaleString()}</p>
                <p><strong>Last Seen:</strong> ${new Date(bot.last_seen * 1000).toLocaleString()}</p>
                <p><strong>Beacon Count:</strong> ${bot.beacon_count || 0}</p>
                <p><strong>Commands Executed:</strong> ${bot.commands_executed || 0}</p>
                <p><strong>Machine GUID:</strong> ${bot.guid || 'N/A'}</p>
            `;
        }
        
        // Update client detail (screenshots, keylogs, etc.)
        function updateClientDetail(details) {
            // Update screenshots
            const screenshotGrid = document.getElementById('screenshot-grid');
            screenshotGrid.innerHTML = '';
            
            if (details.screenshots && details.screenshots.length > 0) {
                details.screenshots.forEach(screenshot => {
                    const thumb = document.createElement('div');
                    thumb.className = 'screenshot-thumb';
                    thumb.innerHTML = `
                        <img src="/api/screenshots/${screenshot.filename}" alt="Screenshot">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 5px; font-size: 0.8em;">
                            ${new Date(screenshot.timestamp * 1000).toLocaleString()}
                        </div>
                    `;
                    thumb.onclick = () => window.open(`/api/screenshots/${screenshot.filename}`, '_blank');
                    screenshotGrid.appendChild(thumb);
                });
            } else {
                screenshotGrid.innerHTML = '<p>No screenshots available</p>';
            }
            
            // Update keylogs
            const keylogViewer = document.getElementById('keylog-viewer');
            if (details.keylogs && details.keylogs.length > 0) {
                const latestKeylog = details.keylogs[details.keylogs.length - 1];
                keylogViewer.innerHTML = `
                    <h4>Latest Keylog: ${latestKeylog.filename}</h4>
                    <div style="margin-top: 10px;">${latestKeylog.preview || 'Loading...'}</div>
                `;
            } else {
                keylogViewer.innerHTML = '<p>No keylog data available</p>';
            }
        }
        
        // Send command to selected bots
        function sendCommand(command, parameters = {}) {
            if (selectedBots.size === 0) {
                showNotification('No bots selected!', 'error');
                return;
            }
            
            if (!ws || !wsConnected) {
                showNotification('Not connected to server!', 'error');
                return;
            }
            
            selectedBots.forEach(botId => {
                const requestId = Date.now() + '_' + Math.random();
                ws.send(JSON.stringify({
                    type: 'command',
                    client_id: botId,
                    command: command,
                    parameters: parameters,
                    request_id: requestId
                }));
            });
            
            showNotification(`Command '${command}' sent to ${selectedBots.size} bot(s)`);
        }
        
        // Handle command result
        function handleCommandResult(result) {
            if (result.status === 'success' || result.status === 'queued') {
                addToActivityLog('COMMAND', result.message);
            } else {
                showNotification(`Command failed: ${result.message}`, 'error');
            }
        }
        
        // Update activity log
        function updateActivityLog(activities) {
            activities.forEach(activity => {
                addToActivityLog(activity.category, `${activity.action} - ${activity.message}`, activity.timestamp);
            });
        }
        
        // Add entry to activity log
        function addToActivityLog(category, message, timestamp = null) {
            const log = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${category.toLowerCase()}`;
            
            const time = timestamp || new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #888;">[${time}]</span> <span style="color: #ff0;">[${category}]</span> ${message}`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 100 entries
            while (log.children.length > 101) { // +1 for title
                log.removeChild(log.children[1]);
            }
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            if (type === 'error') {
                notification.style.background = 'rgba(255,0,0,0.9)';
            }
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Tab switching
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('bot-modal').style.display = 'none';
        }
        
        // Matrix rain effect
        function initMatrix() {
            const canvas = document.getElementById('matrix');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const chars = '01';
            const fontSize = 10;
            const columns = canvas.width / fontSize;
            const drops = [];
            
            for (let i = 0; i < columns; i++) {
                drops[i] = 1;
            }
            
            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#0f0';
                ctx.font = fontSize + 'px monospace';
                
                for (let i = 0; i < drops.length; i++) {
                    const text = chars[Math.floor(Math.random() * chars.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            
            setInterval(draw, 35);
        }
        
        // Initialize
        window.onload = () => {
            initMatrix();
            connectWebSocket();
            
            // Window resize handler
            window.addEventListener('resize', () => {
                const canvas = document.getElementById('matrix');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        };
        
        // Clean up on unload
        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>
